apply plugin: "pmd"
apply plugin: "jacoco"

jacoco {
    toolVersion = "0.8.1"
}

android.applicationVariants.all { variant ->
    def gradleTaskGroup = "codeQuality"
    def variantName = variant.name.capitalize()
    def autoGenerated = ['**/R.class',
                         '**/R$*.class',
                         '**/Manifest*.*',
                         'android/**/*.*',
                         'com/android/databinding/**/*.*',
                         'info/nukoneko/cuc/android/kidspos/databinding/**/*.*',
                         '**/BuildConfig.*',
                         '**/*$ViewBinder*.*',
                         '**/*$ViewInjector*.*',
                         '**/*_ViewBinding*.class',
                         '**/Lambda$*.class',
                         '**/Lambda.class',
                         '**/*Lambda.class',
                         '**/*Lambda*.class']

    variant.assemble.dependsOn "lint$variantName"

    task("pmd${variantName}", type: Pmd, dependsOn: "assemble$variantName") {
        group gradleTaskGroup
        description "Generate ${variantName} Pmd reports."

        ignoreFailures = true
        reports {
            xml {
                enabled = true
                destination new File("${project.rootDir}/build/reports/pmd_report.xml")
            }

            html {
                enabled = false
            }
        }

        source = files(variant.javaCompiler.source)
        classpath = files(configurations.compile.files)
    }

    task("jacoco${variantName}Report", type: JacocoReport, dependsOn: "test${variantName}UnitTest") {
        group gradleTaskGroup
        description "Generate ${variantName} Jacoco coverage reports."

        reports {
            xml.enabled = true
            html.enabled = true
        }

        // variant.javaCompile.source does not work
        // traverses from starting point
        getSourceDirectories().from(files(android.sourceSets.main.java.srcDirs))
        getExecutionData().from(files("${buildDir}/jacoco/test${variantName}UnitTest.exec"))
        getClassDirectories().from(fileTree(dir: variant.javaCompiler.destinationDir, excludes: autoGenerated))
    }
}
